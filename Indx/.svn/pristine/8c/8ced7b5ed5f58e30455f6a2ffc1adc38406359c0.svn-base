package com.zhimu.controller.manager.alipay;

import java.io.IOException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

import com.zhimu.commons.utils.AppUtil;
import com.zhimu.commons.utils.ErrorUtils;
import com.zhimu.commons.utils.PageData;
import com.zhimu.controller.manager.base.BaseController;
import com.zhimu.service.manager.edu.alipay.AlipayConfigUtil;
import com.zhimu.service.manager.edu.alipay.AlipayNotify;
import com.zhimu.service.manager.edu.alipay.AlipaySubmit;
import com.zhimu.service.manager.edu.student.EnrollService;
import com.zhimu.service.manager.redis.RedisCacheUtil;

@Controller
@RequestMapping(value = "/alipay")
public class AliPayController extends BaseController {
	@Resource(name = "redisCacheUtil")
	private RedisCacheUtil redisCacheUtil;
	@Resource(name = "enrollService")
	private EnrollService enrollService;

	/**
	 * 获取订单状态
	 */

	@RequestMapping(value = "/getOrderStatus")
	@ResponseBody
	public Object getOrderStatus() {
		Map<String, String> map = new HashMap<String, String>();
		PageData pd = this.getPageData();
		String result = redisCacheUtil.getCacheObject(pd.getString("orderNo")).toString();
		System.out.println(result + "==============");
		// String cacheObject =
		// redisCacheUtil.getCacheObject(pd.getString("orderNo")).toString();
		// if (null != cacheObject) {
		// result = cacheObject.toString();
		// }
		map.put("msg", redisCacheUtil.getCacheObject(pd.getString("orderNo")).toString());
		return AppUtil.returnObject(new PageData(), map);
	}

	/**
	 * @Description: pc支付宝支付
	 * @author wy
	 */
	@RequestMapping("/alipayInitPay")
	public void alipayInitPay(HttpSession session, HttpServletRequest request, HttpServletResponse response) {
		try {
			// 获取订单号
			String orderNo = request.getParameter("orderNo");
			// 通过订单号获取订单金额
			// String orderAmount =
			// redisCacheUtil.getCacheObject(orderNo).toString();
			String orderAmount = "0.01";

			// 订单商品名称
			String productName = "报名费";
			// 把请求参数打包成数组
			Map<String, String> sParaTemp = new HashMap<>();
			sParaTemp.put("service", AlipayConfigUtil.service);
			sParaTemp.put("partner", AlipayConfigUtil.partner);
			sParaTemp.put("seller_id", AlipayConfigUtil.seller_id);
			sParaTemp.put("_input_charset", AlipayConfigUtil.input_charset);
			sParaTemp.put("payment_type", AlipayConfigUtil.payment_type);
			sParaTemp.put("notify_url", AlipayConfigUtil.notify_url);
			sParaTemp.put("return_url", AlipayConfigUtil.return_url);
			sParaTemp.put("anti_phishing_key", AlipayConfigUtil.anti_phishing_key);
			sParaTemp.put("exter_invoke_ip", AlipayConfigUtil.exter_invoke_ip);
			sParaTemp.put("out_trade_no", orderNo);
			sParaTemp.put("subject", productName);
			sParaTemp.put("total_fee", orderAmount);
			// sParaTemp.put("body", body);
			sParaTemp.put("qr_pay_mode", "2");
			// 建立支付请求
			String form = AlipaySubmit.buildRequest(sParaTemp, "get", "确认");
			response.setContentType("text/html;charset=" + AlipayConfigUtil.input_charset);
			// 直接将完整的表单html输出到页面
			response.getWriter().write(form);
			response.getWriter().flush();
			response.getWriter().close();
		} catch (IOException e) {
			logger.error(ErrorUtils.getErrorMessage(e, "生成订单失败(AliPay)：" + e.getMessage()));
			e.printStackTrace();
		}
	}

	/**
	 * pc支付宝同步通知
	 * 
	 * @param payWayCode
	 * @param httpServletRequest
	 * @param model
	 * @return
	 * @throws Exception
	 */
	@RequestMapping("/result/{payWayCode}")
	public ModelAndView result(@PathVariable("payWayCode") String payWayCode, HttpServletRequest httpServletRequest, Model model) throws Exception {
		ModelAndView mv = new ModelAndView();
		Map<String, String> resultMap = new HashMap<String, String>();
		Map requestParams = httpServletRequest.getParameterMap();
		String msg = "操作成功";
		for (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) {
			String name = (String) iter.next();
			String[] values = (String[]) requestParams.get(name);
			String valueStr = "";
			for (int i = 0; i < values.length; i++) {
				valueStr = (i == values.length - 1) ? valueStr + values[i] : valueStr + values[i] + ",";
			}
			// 乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化
			valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");
			// 支付宝账号
			valueStr = new String(valueStr);
			resultMap.put(name, valueStr);
		}
		if (AlipayNotify.verify(resultMap)) {
			redisCacheUtil.setCacheObject(resultMap.get("out_trade_no"), "1");
			logger.debug("支付宝签名成功返回结果：" + resultMap);
		} else {
			redisCacheUtil.setCacheObject(resultMap.get("out_trade_no"), "2");
			logger.debug("支付宝签名失败返回结果：" + resultMap);
			msg = "支付宝签名失败,订单号：" + resultMap.get("out_trade_no");
		}
		mv.addObject("msg", msg);
		mv.setViewName("edu/student/alipay_result");
		// 页面成功提示
		return mv;
	}

	/**
	 * pc支付宝支付异步通知
	 * 
	 * @param payWayCode
	 * @param httpServletRequest
	 * @param httpServletResponse
	 * @throws Exception
	 */
	@RequestMapping("/notify/{payWayCode}")
	public void notify(@PathVariable("payWayCode") String payWayCode, HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) {
		Map<String, String[]> requestParams = httpServletRequest.getParameterMap();
		Map<String, String> notifyMap = this.parseNotifyMsg(requestParams);
		// 1、签名
		if (AlipayNotify.verify(notifyMap)) {
			// 异步通知业务操作,通过订单号修改业务数据
			PageData pd = new PageData();
			pd.put("orderNo", notifyMap.get("out_trade_no"));
			pd.put("money_status", "1");
			try {
				enrollService.editMoneyStatus(pd);
			} catch (Exception e) {
				logger.error(ErrorUtils.getErrorMessage(e, "订单号：" + notifyMap.get("out_trade_no") + " 回写数据状态异常!"));
				e.printStackTrace();
			}
		} else {
			logger.debug("签名失败返回结果：" + notifyMap);
		}
	}

	/**
	 * @Description: 解析支付宝发来的请求
	 * @author wy
	 * @param requestParams
	 * @param
	 */
	public static Map<String, String> parseNotifyMsg(Map<String, String[]> requestParams) {
		Map<String, String> params = new HashMap<String, String>();
		for (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) {
			String name = (String) iter.next();
			String[] values = requestParams.get(name);
			String valueStr = "";
			for (int i = 0; i < values.length; i++) {
				valueStr = (i == values.length - 1) ? valueStr + values[i] : valueStr + values[i] + ",";
			}
			params.put(name, valueStr);
		}
		return params;
	}
}
