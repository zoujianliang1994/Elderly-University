package com.zhimu.controller.manager.system.user;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import com.zhimu.commons.utils.AppUtil;
import com.zhimu.commons.utils.ErrorUtils;
import com.zhimu.commons.utils.PageData;
import com.zhimu.commons.utils.RightsHelper;
import com.zhimu.dao.entity.system.Menu;
import com.zhimu.dao.entity.system.Role;
import com.zhimu.service.manager.edu.school.SchoolService;
import com.zhimu.service.manager.system.menu.MenuManager;
import net.sf.json.JSONArray;
import org.apache.shiro.crypto.hash.SimpleHash;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

import com.zhimu.controller.manager.base.BaseController;
import com.zhimu.dao.entity.system.Page;
import com.zhimu.dao.entity.system.User;
import com.zhimu.service.manager.system.role.RoleManager;
import com.zhimu.service.manager.system.user.UserManager;

/**
 * 用户管理
 */
@Controller
@RequestMapping(value = "/user")
public class UserController extends BaseController {
	@Resource(name = "userService")
	private UserManager userService;
	@Resource(name = "roleService")
	private RoleManager roleService;
	@Resource(name = "menuService")
	private MenuManager menuService;
	@Resource(name = "schoolService")
	private SchoolService schoolService;

	/**
	 * 显示用户列表
	 */
	@RequestMapping(value = "/listUsers")
	public ModelAndView listUsers(Page page) {
		ModelAndView mv = this.getModelAndView();
		PageData pd = getPageData();
		String keywords = pd.getString("keywords"); // 关键词检索条件
		if (null != keywords && !"".equals(keywords)) {
			pd.put("keywords", keywords.trim());
		}
		User userInfo = getUserInfo();
		try {
			pd.put("type", "1");
			String status = pd.getString("status");
			if ("".equals(status) || null == status) {
				status = "0";
			}
			pd.put("status", status);
			page.setPd(pd);
			List<PageData> userList = userService.listUsers(page); // 列出用户列表
			mv.addObject("userList", userList);
			mv.addObject("pd", pd);
			mv.addObject("userName", userInfo.getUSERNAME());
			mv.setViewName("system/user/user_list");
		} catch (Exception e) {
			logger.error(ErrorUtils.getErrorMessage(e, "用户列表异常"));
		}
		return mv;
	}

	/**
	 * 去新增用户页面
	 */
	@RequestMapping(value = "/goAddU")
	public ModelAndView goAddU(Model model) {
		ModelAndView mv = this.getModelAndView();
		PageData pd = getPageData();
		try {
			String roleRights = "";
			List<Menu> menuList = menuService.listRoleMenuQx("0", null); // 获取所有菜单
			menuList = this.readMenu(menuList, roleRights); // 根据角色权限处理菜单权限状态(递归处理)
			JSONArray arr = JSONArray.fromObject(menuList);
			String json = arr.toString();
			json = json.replaceAll("MENU_ID", "id").replaceAll("PARENT_ID", "pId").replaceAll("MENU_NAME", "title").replaceAll("subMenu", "children").replaceAll("hasMenu", "isChecked");
			model.addAttribute("zTreeNodes", json);

			mv.addObject("msg", "saveU");
			mv.addObject("pd", pd);
			mv.addObject("isAdmin", "admin".equals(getUserInfo().getUSERNAME()) ? true : false);
			mv.setViewName("system/user/user_edit");
		} catch (Exception e) {
			logger.error(ErrorUtils.getErrorMessage(e, "打开用户新增页面异常!"));
		}
		return mv;
	}

	/**
	 * 保存用户
	 */
	@RequestMapping(value = "/saveU", method = RequestMethod.POST)
	@ResponseBody
	public Object saveU() {
		Map<String, String> map = new HashMap<String, String>();
		PageData pd = getPageData();
		String msg = "";
		try {
			pd.put("USER_ID", this.get32UUID()); // ID 主键
			pd.put("STATUS", "0");
			pd.put("PASSWORD", new SimpleHash("SHA-1", pd.getString("USERNAME"), pd.getString("PASSWORD")).toString()); // 密码加密
			if (null == userService.findByUsername(pd)) { // 判断用户名是否存在
				// 保存用户
				String ROLE_ID = this.get32UUID(); // 角色id
				String menuIds = pd.getString("menuIds");
				pd.put("ROLE_ID",ROLE_ID + ",");
				userService.saveU(pd); // 执行保存

				// 新增用户对应的角色
				String username = pd.getString("USERNAME"); // 获取新增的用户名
				pd.clear();
				pd.put("ROLE_NAME", username); // 将用户名作为角色名称
				pd.put("RIGHTS", ""); // 菜单权限
				pd.put("PARENT_ID", "1");
				pd.put("ROLE_ID", ROLE_ID); // 主键
				pd.put("ADD_QX", "0"); // 初始新增权限为否
				pd.put("DEL_QX", "0"); // 删除权限
				pd.put("EDIT_QX", "0"); // 修改权限
				pd.put("CHA_QX", "0"); // 查看权限
				roleService.add(pd); // 新增用户角色

				// 给新增的用户角色添加权限
				roleService.addRolePermission(ROLE_ID, menuIds);
				msg = "success";
			} else {
				msg = "fail";
			}
		} catch (Exception e) {
			msg = "error";
			logger.error(ErrorUtils.getErrorMessage(e, "保存用户异常!"));
		}
		map.put("result", msg);
		return AppUtil.returnObject(new PageData(), map);
	}

	/**
	 * 去修改用户页面
	 */
	@RequestMapping(value = "/goEditU")
	public ModelAndView goEditU(Model model) {
		ModelAndView mv = this.getModelAndView();
		PageData pd = getPageData();
		try {
			String TYPE = pd.getString("TYPE");
			String currentPage = pd.getString("currentPage");
			pd = userService.findById(pd); // 根据ID读取
			pd.put("currentPage", currentPage);
			pd.put("TYPE", TYPE);

			// 获取用户角色对应的权限
			String roleId = pd.getString("ROLE_ID");
			roleId = roleId.substring(0, roleId.indexOf(","));
			Role role = roleService.getRoleById(roleId); // 根据角色ID获取角色对象
			String roleRights = role.getRIGHTS(); // 取出本角色菜单权限
			List<Menu> menuList = menuService.listRoleMenuQx("0", roleId); // 获取所有菜单
			menuList = this.readMenu(menuList, roleRights); // 根据角色权限处理菜单权限状态(递归处理)
			JSONArray arr = JSONArray.fromObject(menuList);
			String json = arr.toString();
			json = json.replaceAll("MENU_ID", "id").replaceAll("PARENT_ID", "pId").replaceAll("MENU_NAME", "title").replaceAll("subMenu", "children").replaceAll("hasMenu", "isChecked");
			model.addAttribute("zTreeNodes", json);

			mv.addObject("ROLE_ID", roleId);
			mv.addObject("msg", "editU");
			mv.addObject("pd", pd);
			mv.addObject("isAdmin", "admin".equals(getUserInfo().getUSERNAME()) ? true : false);
			mv.setViewName("system/user/user_edit");
		} catch (Exception e) {
			logger.error(ErrorUtils.getErrorMessage(e, "去修改用户页面异常!"));
		}
		return mv;
	}

	/**
	 * 修改用户
	 */
	@RequestMapping(value = "/editU", method = RequestMethod.POST)
	@ResponseBody
	public Object editU() throws Exception {
		Map<String, String> map = new HashMap<String, String>();
		PageData pd = getPageData();
		String msg = "";
		try {
			if (pd.getString("PASSWORD") != null && !"".equals(pd.getString("PASSWORD"))) {
				pd.put("PASSWORD", new SimpleHash("SHA-1", pd.getString("USERNAME"), pd.getString("PASSWORD")).toString());
			}

			String menuIds = pd.getString("menuIds"); // 权限菜单id

			// 删除原来的角色和对应权限
			Map roleMap = new HashMap<String,String>();
			String oldRoleId = pd.getString("ROLE_ID");
			oldRoleId = oldRoleId.substring(0, oldRoleId.indexOf(","));
			roleMap.put("ROLE_ID", oldRoleId);
			roleService.deleteRolePermission(roleMap);

			// 删除用户对应角色
			roleService.deleteRoleById(oldRoleId);

			// 修改
			String roleId = this.get32UUID(); // 角色id
			pd.put("ROLE_ID", roleId + ",");
			userService.editU(pd); // 执行修改

			// 用户对应的角色
			String username = pd.getString("USERNAME"); // 获取新增的用户名
			pd.clear();
			pd.put("ROLE_NAME", username); // 将用户名作为角色名称
			pd.put("RIGHTS", ""); // 菜单权限
			pd.put("PARENT_ID", "1");
			pd.put("ROLE_ID", roleId); // 主键
			pd.put("ADD_QX", "0"); // 初始新增权限为否
			pd.put("DEL_QX", "0"); // 删除权限
			pd.put("EDIT_QX", "0"); // 修改权限
			pd.put("CHA_QX", "0"); // 查看权限
			roleService.add(pd); // 新增用户角色

			// 给用户角色添加权限
			roleService.addRolePermission(roleId, menuIds);

			msg = "success";
		} catch (Exception e) {
			msg = "error";
			logger.error(ErrorUtils.getErrorMessage(e, "修改用户异常"));
		}
		map.put("result", msg);
		return AppUtil.returnObject(new PageData(), map);
	}

	/**
	 * 删除用户
	 */
	@RequestMapping(value = "/deleteU")
	@ResponseBody
	public Object delete() {
		Map<String, String> map = new HashMap<String, String>();
		PageData pd = getPageData();
		String resultInfo = "";
		try {
			// 删除角色权限表对应数据
			Map roleMap = new HashMap<String,String>();
			String roleId = pd.getString("ROLE_ID");
			roleId = roleId.substring(0, roleId.indexOf(","));
			roleMap.put("ROLE_ID", roleId);
			roleService.deleteRolePermission(roleMap);

			// 删除用户对应角色
			roleService.deleteRoleById(roleId);

			// 删除用户
			userService.deleteU(pd);
			resultInfo = "success";
		} catch (Exception e) {
			resultInfo = "error";
			logger.error(ErrorUtils.getErrorMessage(e, "删除用户异常!"));
		}
		map.put("result", resultInfo);
		return AppUtil.returnObject(new PageData(), map);
	}

	/**
	 * 判断用户名是否存在
	 * 
	 * @return
	 */
	@RequestMapping(value = "/checkUserName")
	@ResponseBody
	public Object checkUserName() {
		Map<String, String> map = new HashMap<String, String>();
		String msg = "";
		PageData pd = getPageData();
		try {
			if (userService.findByUsername(pd) == null) {
				msg = "no";
			} else {
				msg = "yes";
			}
		} catch (Exception e) {
			msg = "error";
			logger.error(ErrorUtils.getErrorMessage(e, "判断用户名是否存在异常!"));
		}
		map.put("result", msg);
		return AppUtil.returnObject(new PageData(), map);
	}

	/**
	 * 去修改用户密码页面
	 */
	@RequestMapping(value = "/goEditPassWord")
	public ModelAndView goEditPassWord() {
		ModelAndView mv = this.getModelAndView();
		PageData pd = getPageData();
		try {
			pd = userService.findById(pd);
			mv.addObject("msg", "editPassWord");
			mv.addObject("pd", pd);
			mv.setViewName("system/user/user_password");
		} catch (Exception e) {
			logger.error(ErrorUtils.getErrorMessage(e, "去修改用户密码页面异常!"));
		}
		return mv;
	}

	/**
	 * 修改用户密码
	 */
	@RequestMapping(value = "/editPassWord", method = RequestMethod.POST)
	@ResponseBody
	public Object editPassWord() throws Exception {
		Map<String, String> map = new HashMap<String, String>();
		PageData pd = getPageData();
		String msg = "";
		try {
			String NEW_PASSWORD = pd.getString("NEW_PASSWORD").trim();
			String USERNAME = pd.getString("USERNAME").trim();
			// 密码加密
			String PASSWORD = new SimpleHash("SHA-1", USERNAME, pd.getString("PASSWORD").trim()).toString();
			pd.put("USERNAME", USERNAME);
			pd.put("PASSWORD", PASSWORD);
			// 根据用户名和密码去读取用户信息
			pd = userService.getUserByNameAndPwd(pd);
			if (pd != null) {
				// 新密码加密
				String NEW_PWD = new SimpleHash("SHA-1", USERNAME, NEW_PASSWORD).toString();
				pd.put("NEW_PWD", NEW_PWD);
				// 执行修改
				userService.editPassWord(pd);
				msg = "success";
			} else {
				msg = "fail";
			}
		} catch (Exception e) {
			msg = "error";
			logger.error(ErrorUtils.getErrorMessage(e, "修改用户密码异常"));
		}
		map.put("result", msg);
		return AppUtil.returnObject(new PageData(), map);
	}

	/**
	 * 修改用户状态
	 */
	@RequestMapping(value = "/updateStatus")
	@ResponseBody
	public Object updateStatus() {
		Map<String, String> map = new HashMap<String, String>();
		PageData pd = getPageData();
		String resultInfo = "";
		try {
			userService.updateStatus(pd);
			resultInfo = "success";
		} catch (Exception e) {
			resultInfo = "error";
			logger.error(ErrorUtils.getErrorMessage(e, "修改用户状态异常!"));
		}
		map.put("result", resultInfo);
		return AppUtil.returnObject(new PageData(), map);
	}

	/**
	 * 查询内设机构或者角色
	 */
	@RequestMapping(value = "/listSectionOrRoles")
	@ResponseBody
	public Object listSectionOrRoles() {
		Map<String, String> map = new HashMap<String, String>();
		PageData pd = getPageData();
		JSONArray arr = null;
		String json = "";
		try {
			User userInfo = getUserInfo();
			String TYPE = pd.getString("TYPE");
			// String optType = pd.getString("optType");
			if ("1".equals(TYPE)) {
			// 	// 内设机构
			// 	pd.put("type", "1");// 默认不查询外部单位
				// if ("admin".equals(userInfo.getUSER_ID())) {
				// 	// 查询所有内设机构
				// 	pd.put("depId", "");
				// 	arr = JSONArray.fromObject(sectionService.listSectionByDep(pd));
				// } else {
				// 	// 根据机构查询内设机构
				// 	String areaCode = userInfo.getAreaCode();
				// 	String userLevel = userInfo.getUserLevel();
				// 	// 如果是区县及以上人员，只能增加自己所在层级内部人员信息
				// 	// if (!"3".equals(userLevel) && !"4".equals(userLevel)) {
				// 	//
				// 	// } else
				// 	if ("3".equals(userInfo.getUserLevel())) {
				// 		areaCode = areaCode.substring(0, areaCode.length() - 3);
				// 	} else {
				// 		areaCode = userInfo.getAreaCode().length() == 12 ? (AreaCodeUtils.returnXzqh(userInfo.getAreaCode())) : userInfo.getAreaCode();
				// 	}
				// 	pd.put("areaCode", areaCode);
				// 	List<Section> departMentList = this.sectionService.findByAreaCodeName(pd);
				// 	pd.put("depId", userInfo.getDEP_ID());
				// 	arr = JSONArray.fromObject(departMentList);
				// }
				// json = arr.toString();
				// json = json.replaceAll("SECTION_ID", "id").replaceAll("NAME", "title");
			} else {
				List<String> liststr = new ArrayList<String>();
				// 根据用户层级查询所属角色
				pd.put("ROLE_ID", "1");
				// 系统管理员除外
				// if (!"admin".equals(userInfo.getUSERNAME()) &&
				// !"2".equals(userInfo.getUserLevel()) &&
				// !"1".equals(userInfo.getUserLevel())) {
				// liststr.add(userInfo.getUserLevel());
				// }
				if ("admin".equals(userInfo.getUSERNAME()) || "0".equals(userInfo.getUserLevel())) {
					liststr.add("0");
					liststr.add("1");
					liststr.add("2");
					liststr.add("3");
					liststr.add("4");
				}
				// 区县级人员可以查看乡镇、街道、村、社区下面所有角色
				if ("1".equals(userInfo.getUserLevel())) {
					liststr.add("1");
					liststr.add("2");
					// liststr.add("3");
					// liststr.add("4");
				} else if ("2".equals(userInfo.getUserLevel())) {
					// liststr.add("2");
					liststr.add("3");
					liststr.add("4");
				} else if ("3".equals(userInfo.getUserLevel())) {
					liststr.add("3");
					liststr.add("4");
				} else {
					liststr.add(userInfo.getUserLevel());
				}
				pd.put("list", liststr);
				// 列出所有系统角色
				List<Role> listAllRolesByPId = roleService.listAllRolesByPIdLevel(pd);
				String str = "";
				for (Role role : listAllRolesByPId) {
					if ("0".equals(role.getRoleLevel())) {
						str = "省";
					} else if ("1".equals(role.getRoleLevel())) {
						str = "市、洲";
					} else if ("2".equals(role.getRoleLevel())) {
						str = "区、县";
					} else if ("3".equals(role.getRoleLevel())) {
						str = "乡镇、街道办";
					} else if ("4".equals(role.getRoleLevel())) {
						str = "村、社区";
					}
					role.setROLE_NAME(role.getROLE_NAME() + "（" + str + "）");
				}
				arr = JSONArray.fromObject(listAllRolesByPId);

				json = arr.toString();
				json = json.replaceAll("ROLE_ID", "id").replaceAll("ROLE_NAME", "title");
			}
			map.put("data", json);
		} catch (Exception e) {
			logger.error(ErrorUtils.getErrorMessage(e, "显示列表ztree异常"));
		}
		return map;
	}

	/**
	 * 根据角色权限处理权限状态(递归处理)
	 *
	 * @param menuList
	 *            ：传入的总菜单
	 * @param roleRights
	 *            ：加密的权限字符串
	 * @return
	 */
	private List<Menu> readMenu(List<Menu> menuList, String roleRights) throws Exception {
		for (int i = 0; i < menuList.size(); i++) {
			// 最末层菜单,菜单对应的权限
			if ("endFrame".equals(menuList.get(i).getTarget())) {
				if ("0".equals(menuList.get(i).getMENU_STATE())) {
					menuList.get(i).setHasMenu(false);
				} else {
					menuList.get(i).setHasMenu(true);
				}
			} else {
				menuList.get(i).setHasMenu(RightsHelper.testRights(roleRights, menuList.get(i).getMENU_ID()));
				this.readMenu(menuList.get(i).getSubMenu(), roleRights); // 是：继续排查其子菜单
			}
		}
		return menuList;
	}

}
